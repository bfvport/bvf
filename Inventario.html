<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Inventario y Precios</title>
     <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <!-- Carga de Tailwind CSS para una estética moderna y responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Phosphor Icons para iconos modernos -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* Estilos personalizados para darle un toque único y cumplir con "muchos detalles estéticos" */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Fondo suave */
        }

        /* Estilo para el contenedor principal con un poco de profundidad */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Estilo para tarjetas y contenedores de datos */
        .card {
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        /* Estilo para botones principales con gradiente y sombra */
        .btn-primary {
            background: linear-gradient(45deg, #10b981, #059669); /* Gradiente Teal-Esmeralda */
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
            transform: translateY(-1px);
        }

        /* Estilo para el encabezado de la tabla con efecto de sombra sutil */
        #inventory-table th {
            background-color: #e0f2f1; /* Fondo suave para el encabezado */
            color: #0d9488; /* Texto Teal */
            font-weight: 700;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 3px solid #0d9488;
        }

        /* Estilo para filas de la tabla */
        #inventory-table tr {
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.15s ease;
        }

        #inventory-table tr:hover {
            background-color: #f0fdfa; /* Efecto hover sutil */
        }

        /* Estilo del Modal */
        .modal-content {
            background-color: #ffffff;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            margin: 50px auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
        }

        /* Campos de formulario */
        .input-field {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px;
            width: 100%;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .input-field:focus {
            border-color: #0d9488;
            outline: none;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }

        .category-pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
<header id="header">
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo">BF<span>V</span></a>
                <ul class="nav-links">
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="nosotros.html">Nosotros</a></li>
                    <li><a href="productos.html">Productos</a></li>
                    <li><a href="contacto.html">Contacto</a></li>
                </ul>
                <div class="mobile-menu">
                    <i class="fas fa-bars"></i>
                </div>
            </nav>
        </div>
    </header>
    <!-- Contenedor Principal de la App -->
    <div class="app-container">
        <!-- Encabezado y Acciones -->
        <header class="mb-8 p-6 card flex flex-col md:flex-row justify-between items-center bg-teal-50">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-4 md:mb-0">
                <i class="ph-bold ph-factory text-teal-600 mr-2"></i>
                Inventario Local
            </h1>
            <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                <!-- Selector de Categorías -->
                <select id="category-filter" onchange="filterProducts()" class="input-field w-full sm:w-48 bg-white">
                    <option value="">Todas las Categorías</option>
                    <!-- Las categorías se llenarán dinámicamente -->
                </select>

                <!-- Botón para Agregar Nuevo Producto -->
                <button onclick="openModal('add')" class="btn-primary flex items-center justify-center w-full sm:w-auto">
                    <i class="ph ph-plus text-lg mr-2"></i>
                    Añadir Producto
                </button>
            </div>
        </header>

        <!-- Mensaje de Estado (Cargando / Error) -->
        <div id="status-message" class="hidden p-4 mb-4 text-sm text-blue-700 bg-blue-100 rounded-lg" role="alert">
            Cargando inventario...
        </div>

        <!-- Tabla de Inventario -->
        <div class="card p-4 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="inventory-table">
                <thead>
                    <tr>
                        <th class="px-6 py-3">Nombre</th>
                        <th class="px-6 py-3">Categoría</th>
                        <th class="px-6 py-3 text-right">Cantidad</th>
                        <th class="px-6 py-3 text-right">Precio ($)</th>
                        <th class="px-6 py-3 text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="inventory-body" class="bg-white divide-y divide-gray-100">
                    <!-- Filas de productos se insertarán aquí por JavaScript -->
                </tbody>
            </table>
            <!-- Mensaje si no hay productos -->
            <p id="no-items-message" class="text-center text-gray-500 py-10 hidden">No hay productos en el inventario. ¡Añade uno nuevo para empezar!</p>
        </div>
    </div>

    <!-- Modal para Añadir/Editar Producto (Overlay) -->
    <div id="item-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 transition-opacity duration-300">
        <div class="modal-content relative top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700">
                <i class="ph ph-x text-xl"></i>
            </button>
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-gray-800">Añadir Nuevo Producto</h2>

            <form id="item-form" onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="item-id">
                <input type="hidden" id="form-mode" value="add">

                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto</label>
                    <input type="text" id="name" required class="input-field" placeholder="Ej: Tostadora Eléctrica">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                        <input type="text" id="category" required class="input-field" placeholder="Ej: Electrodomésticos">
                    </div>

                    <div class="mb-4">
                        <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Precio ($)</label>
                        <input type="number" id="price" required min="0.01" step="0.01" class="input-field text-right" placeholder="0.00">
                    </div>
                </div>

                <div class="mb-6">
                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad en Stock</label>
                    <input type="number" id="quantity" required min="0" class="input-field text-right" placeholder="0">
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Cancelar</button>
                    <button type="submit" class="btn-primary" id="submit-button">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmación de Eliminación -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center">
        <div class="modal-content max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Confirmar Eliminación</h3>
            <p class="text-gray-600 mb-6">¿Estás seguro de que deseas eliminar <strong id="item-to-delete-name"></strong> del inventario? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('confirm-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Cancelar</button>
                <button onclick="confirmDelete()" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">Eliminar</button>
            </div>
            <input type="hidden" id="item-to-delete-id">
        </div>
    </div>

    <!-- Firebase SDKs (Cargadas como módulos) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, getDocs, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de registro para depuración
        setLogLevel('error'); // Cambiar a 'debug' si es necesario

        // Variables Globales de Firebase (PROPORCIONADAS POR EL ENTORNO)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let unsubscribe = null; // Para detener la escucha de Firestore
        let allCategories = new Set();
        let currentProducts = [];

        // 1. Inicialización de Firebase
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase inicializado con éxito.");

                // Manejo de la autenticación
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuario autenticado con ID:", userId);
                        // Iniciar la escucha del inventario una vez autenticado
                        startInventoryListener();
                        document.getElementById('status-message').classList.add('hidden');
                    } else {
                        // Intentar inicio de sesión
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Error al autenticar:", error);
                            document.getElementById('status-message').textContent = "Error de autenticación. Verifica la consola.";
                            document.getElementById('status-message').classList.remove('hidden');
                        }
                    }
                });

                document.getElementById('status-message').textContent = "Autenticando y cargando inventario...";
                document.getElementById('status-message').classList.remove('hidden');

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                document.getElementById('status-message').textContent = `Error al iniciar la aplicación: ${error.message}`;
                document.getElementById('status-message').classList.remove('hidden');
            }
        };

        // 2. Escucha en tiempo real del inventario (CRUD - Read)
        const startInventoryListener = () => {
            if (unsubscribe) {
                unsubscribe(); // Detener la escucha anterior si existe
            }

            if (!db || !userId) {
                console.error("Base de datos o ID de usuario no disponible.");
                return;
            }

            // Ruta de la colección: /artifacts/{appId}/users/{userId}/inventory_items
            const inventoryCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/inventory_items`);
            
            // La función onSnapshot escucha los cambios en tiempo real
            unsubscribe = onSnapshot(inventoryCollectionRef, (snapshot) => {
                const items = [];
                allCategories.clear();
                allCategories.add("Todas las Categorías");

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const item = { id: doc.id, ...data };
                    items.push(item);
                    allCategories.add(item.category);
                });

                currentProducts = items; // Almacena todos los productos

                // 1. Actualizar el selector de categorías
                populateCategoryFilter();
                
                // 2. Renderizar la tabla con los productos actuales (filtrado por defecto a "Todas")
                renderInventory(items);

                document.getElementById('status-message').classList.add('hidden');
            }, (error) => {
                console.error("Error al obtener datos en tiempo real:", error);
                document.getElementById('status-message').textContent = `Error al cargar inventario: ${error.message}`;
                document.getElementById('status-message').classList.remove('hidden');
            });
        };

        // 3. Funciones de Renderizado y Filtrado
        window.populateCategoryFilter = () => {
            const filterEl = document.getElementById('category-filter');
            const currentFilter = filterEl.value; // Guardar el filtro actual

            filterEl.innerHTML = ''; // Limpiar opciones

            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category === "Todas las Categorías" ? "" : category;
                option.textContent = category;
                if (category === "Todas las Categorías" && currentFilter === "") {
                    option.selected = true;
                } else if (category === currentFilter) {
                    option.selected = true;
                }
                filterEl.appendChild(option);
            });
        };

        window.renderInventory = (itemsToRender) => {
            const tbody = document.getElementById('inventory-body');
            tbody.innerHTML = '';
            const noItemsMessage = document.getElementById('no-items-message');

            if (itemsToRender.length === 0) {
                noItemsMessage.classList.remove('hidden');
                return;
            }

            noItemsMessage.classList.add('hidden');

            // Ordenar por nombre antes de renderizar
            itemsToRender.sort((a, b) => a.name.localeCompare(b.name));

            itemsToRender.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                // Función para obtener la clase de color para el "pill" de categoría
                const getCategoryColor = (cat) => {
                    const hash = Array.from(cat).reduce((acc, char) => char.charCodeAt(0) + acc, 0);
                    const colors = [
                        { bg: 'bg-blue-100', text: 'text-blue-800' },
                        { bg: 'bg-green-100', text: 'text-green-800' },
                        { bg: 'bg-purple-100', text: 'text-purple-800' },
                        { bg: 'bg-yellow-100', text: 'text-yellow-800' },
                        { bg: 'bg-red-100', text: 'text-red-800' }
                    ];
                    return colors[hash % colors.length];
                };
                const { bg, text } = getCategoryColor(item.category);


                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="category-pill ${bg} ${text}">
                            ${item.category}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right font-mono">${item.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right font-mono">$${item.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="openModal('edit', '${item.id}')" class="text-indigo-600 hover:text-indigo-900 p-2 rounded-full hover:bg-indigo-50 transition-colors" title="Editar">
                                <i class="ph ph-pencil text-lg"></i>
                            </button>
                            <button onclick="prepareDelete('${item.id}', '${item.name}')" class="text-red-600 hover:text-red-900 p-2 rounded-full hover:bg-red-50 transition-colors" title="Eliminar">
                                <i class="ph ph-trash text-lg"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        };

        window.filterProducts = () => {
            const filterValue = document.getElementById('category-filter').value;
            let filteredItems = currentProducts;

            if (filterValue) {
                filteredItems = currentProducts.filter(item => item.category === filterValue);
            }

            renderInventory(filteredItems);
        };

        // 4. Lógica de Modales y Formulario (CRUD - Create/Update)
        window.openModal = async (mode, id = null) => {
            const modal = document.getElementById('item-modal');
            const title = document.getElementById('modal-title');
            const formMode = document.getElementById('form-mode');
            const submitButton = document.getElementById('submit-button');
            const form = document.getElementById('item-form');
            form.reset(); // Limpiar formulario

            formMode.value = mode;

            if (mode === 'add') {
                title.textContent = 'Añadir Nuevo Producto';
                submitButton.textContent = 'Crear Producto';
                document.getElementById('item-id').value = '';
            } else if (mode === 'edit' && id) {
                title.textContent = 'Editar Producto';
                submitButton.textContent = 'Actualizar Producto';
                document.getElementById('item-id').value = id;

                // Cargar datos del ítem
                const item = currentProducts.find(p => p.id === id);
                if (item) {
                    document.getElementById('name').value = item.name;
                    document.getElementById('category').value = item.category;
                    document.getElementById('price').value = item.price;
                    document.getElementById('quantity').value = item.quantity;
                }
            }
            
            modal.classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('item-modal').classList.add('hidden');
        };

        window.handleFormSubmit = async (event) => {
            event.preventDefault();
            
            const mode = document.getElementById('form-mode').value;
            const id = document.getElementById('item-id').value;
            const name = document.getElementById('name').value.trim();
            const category = document.getElementById('category').value.trim();
            const price = parseFloat(document.getElementById('price').value);
            const quantity = parseInt(document.getElementById('quantity').value, 10);

            const newItemData = {
                name: name,
                category: category,
                price: price,
                quantity: quantity,
                timestamp: Date.now()
            };
            
            if (!db || !userId) {
                console.error("Base de datos o usuario no disponible.");
                return;
            }

            const inventoryCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/inventory_items`);

            try {
                if (mode === 'add') {
                    // Crear nuevo documento (Add)
                    await addDoc(inventoryCollectionRef, newItemData);
                    console.log("Producto añadido con éxito.");
                } else if (mode === 'edit' && id) {
                    // Actualizar documento existente (Update)
                    const itemDocRef = doc(db, `artifacts/${appId}/users/${userId}/inventory_items`, id);
                    await updateDoc(itemDocRef, newItemData);
                    console.log("Producto actualizado con éxito.");
                }

                closeModal();
            } catch (error) {
                console.error(`Error al ${mode === 'add' ? 'añadir' : 'actualizar'} el producto:`, error);
                // Aquí podrías mostrar un mensaje de error al usuario
            }
        };

        // 5. Lógica de Eliminación (CRUD - Delete)
        window.prepareDelete = (id, name) => {
            document.getElementById('item-to-delete-id').value = id;
            document.getElementById('item-to-delete-name').textContent = name;
            document.getElementById('confirm-modal').classList.remove('hidden');
        };

        window.confirmDelete = async () => {
            const id = document.getElementById('item-to-delete-id').value;
            document.getElementById('confirm-modal').classList.add('hidden'); // Cerrar modal

            if (!db || !userId || !id) {
                console.error("Base de datos, usuario o ID no disponible para eliminar.");
                return;
            }

            try {
                // Eliminar documento (Delete)
                const itemDocRef = doc(db, `artifacts/${appId}/users/${userId}/inventory_items`, id);
                await deleteDoc(itemDocRef);
                console.log("Producto eliminado con éxito.");
            } catch (error) {
                console.error("Error al eliminar el producto:", error);
                // Aquí podrías mostrar un mensaje de error al usuario
            }
        };

        // Iniciar la aplicación al cargar la ventana
        window.onload = initFirebase;
    </script>
</body>
</html>
